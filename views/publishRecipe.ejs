<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>发表菜谱</title>
</head>
<div class="alert bg-primary" role="alert">菜谱管理&nbsp;&nbsp;>>&nbsp;发表菜谱</div>

<meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<title>Document</title>
<script src="../public/javascripts/jquery.min.js"></script>
<script>
    $(function () {
        let dietP = '';
        // 显示
        $('input[type=file]').change(function () {
            let result = $('#result');
            if (typeof FileReader == 'undefined') {
                result.innerHTML = "抱歉，你的浏览器不支持FileReader";
            }
            var simpleFile = document.getElementById("file").files[0];
            if (!/image\/\w+/.test(simpleFile.type)) {
                alert("请确保文件类型为图像类型");
                return false;
            }
            var reader = new FileReader();
            // 将文件以Data URL形式进行读入页面-- 转base64位
            reader.readAsDataURL(simpleFile);
            reader.onload = function (e) {
                console.log(this.result); // -- base64位
                dietP = this.result;
                result.html('<img src="' + this.result + '" alt=""/>');
            }
        });
        // 传数据
        $('input[type=button]').click(function () {
            //获取到标题 + 简介
            let dieltT = $('.dieltTitle').val();
            let dieltS = $('.dieltSyon').val();

            let foodlist = [];
            for (let i = 0; i < $('.foodlist').length; i += 2) {
                var food = {};
                food.Name = document.getElementsByClassName('foodlist')[i].value;
                food.Num = document.getElementsByClassName('foodlist')[i + 1].value;
                foodlist.push(food);
            }

            let steplist = [];
            for (let j = 0; j < $('.stepTitle').length; j++) {
                let step = {};
                let formDataStep = new FormData();
                step.stepContent = document.getElementsByClassName('stepTitle')[j].value;
                step.stepPhoto = document.getElementsByClassName('stepFile')[j].files[0].name; // 获取到名字
                steplist.push(step);
            }

            let formData = new FormData();
            //-----食谱
            formData.append('dieltTitle', dieltT);
            formData.append('dieltSyon', dieltS);
            //-----食材
            formData.append('foodlist', JSON.stringify(foodlist));
            //-----步骤
            formData.append('steplist', JSON.stringify(steplist));

            //-----所有的图片
            for (var k = 0; k < $("[type=file]").length; k++) {
                // 传入的文件名设置 -------
                formData.append(`dieltFile${k}`, document.getElementsByClassName('file')[k].files[0]);
            }

            $.ajax({
                url: 'http://127.0.0.1:3000/operat/upload',
                type: "POST",

                cache: false,
                processData: false,
                contentType: false,

                data: formData,
                success: function (data) {
                    console.log('成功！' + data);
                },
                error: function (err) {
                    console.log('失败' + err.message);
                }
            })
        });
    });
</script>
<style>
    table {
        width: 800px;
        height: 500px;
    }
    tr>td:first-child {
        width: 80px;
    }
    td {
        text-align: center;
    }
</style>
<body>

<form action="">
    <table border="1" align="center">
        <tr>
            <td>Id:</td>
            <td colspan="4">
                <input type="text" class="userId" name="userId">
            </td>
        </tr>
        <tr>
            <td>标题：</td>
            <td colspan="4">
                <input type="text" class="dieltTitle" name="dieltTitle">
            </td>
        </tr>
        <tr>
            <td>简介：</td>
            <td colspan="4">
                <textarea class="dieltSyon" name="dieltSyon" id="" cols="60" rows="3"></textarea>
            </td>
        </tr>
        <tr>
            <td>食谱图片：</td>
            <td colspan="4">
                <input type="file" name="dietPhoto" id="file" class="file">
            </td>
        </tr>
        <tr>
            <td>食材：</td>
            <td>
                <input type="text" class="foodlist" name="food1">
            </td>
            <td>数量:</td>
            <td>
                <input type="text" class="foodlist" name="food1">
            </td>
            <td>
                <button>+</button>
            </td>
        </tr>
        <tr>
            <td>步骤:</td>
            <td>
                <textarea class="stepTitle" name="stepTitle" id="" cols="30" rows="5"></textarea>
            </td>
            <td>步骤图片:</td>
            <td>
                <input type="file" name="stepFile" class="stepFile file">
            </td>
            <td>
                <button>+</button>
            </td>
        </tr>
        <tr>
            <td colspan="5"><input type="button" value="提交"></td></tr>
    </table>
</form>
</body>
</html>